name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
    paths:
      - "web/**"
      - "data/**"
  workflow_run:
    workflows:
      - "Update Infectious Disease Data"
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: astral-sh/setup-uv@v6
      
      - name: Generated Parquet files
        run: |
          uv run main.py merge

      - name: Check data
        run: |
          tree -L 3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: web
        run: bun install

      - name: Copy data to public folder
        run: |
          cd web
          make copy-data
          
      - name: Note on Parquet files
        run: |
          echo "Parquet files will be uploaded separately to D2 (see next step)"
          echo "Website will fetch data from D2 instead of bundling files"

      - name: Build website
        working-directory: web
        run: bun run build

      - name: Upload Parquet files to D2
        run: |
          npm install -g wrangler
          
          # Upload parquet files to D2
          wrangler r2 object put data/zensu/merged_zensu.parquet --bucket=kansenshou-data --file=data/zensu/merged_zensu.parquet || true
          wrangler r2 object put data/ari/merged_ari.parquet --bucket=kansenshou-data --file=data/ari/merged_ari.parquet || true
          wrangler r2 object put data/teiten/merged_teiten.parquet --bucket=kansenshou-data --file=data/teiten/merged_teiten.parquet || true
          wrangler r2 object put data/trend/merged_trend.parquet --bucket=kansenshou-data --file=data/trend/merged_trend.parquet || true
          
          echo "Parquet files uploaded to D2"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy website to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=kansenshou --commit-dirty=true
          workingDirectory: web
